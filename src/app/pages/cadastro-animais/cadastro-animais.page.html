<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="voltar()"></ion-back-button>
    </ion-buttons>
    <ion-title>Cadastro de Animais</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="segment-container">
    <ion-segment [formControl]="segmentoControl" (ionChange)="mudarSegmento()">
      <ion-segment-button value="nascidos">
        <ion-label>Nascimento</ion-label>
      </ion-segment-button>
      <ion-segment-button value="comprados">
        <ion-label>Compra</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Formul√°rio para animais nascidos na propriedade -->
  <form *ngIf="segmento === 'nascidos'" [formGroup]="formNascidos" (ngSubmit)="cadastrarNascido()"
    class="form-container">

    <!-- DADOS DO PARTO (FIXOS) -->
    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Dados do Parto</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label position="stacked" class="required-label">Data do Parto</ion-label>
        <ion-input formControlName="dataParto" placeholder="DD/MM/AAAA" (click)="abrirCalendario()">
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Tipo de Parto</ion-label>
        <ion-select formControlName="tipoParto" (ionChange)="ajustarQuantidadeFilhotes()" placeholder="Selecione o tipo"
          interface="action-sheet">
          <ion-select-option value="simples">Simples</ion-select-option>
          <ion-select-option value="duplo">Duplo</ion-select-option>
          <ion-select-option value="triplo">Triplo</ion-select-option>
          <ion-select-option value="quadruplo">Qu√°druplo</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Identifica√ß√£o da M√£e</ion-label>
        <ion-select formControlName="identificacaoMae" placeholder="Selecione a m√£e" interface="action-sheet">
          <ion-select-option *ngFor="let animal of animaisFemeas" [value]="animal.id">
            {{ formatarExibicaoGenitor(animal) }}
          </ion-select-option>
        </ion-select>
        <ion-note *ngIf="animaisFemeas.length === 0 && !carregandoGenitores" color="medium" slot="end">
          Nenhuma f√™mea dispon√≠vel
        </ion-note>
        <ion-note *ngIf="carregandoGenitores" color="medium" slot="end">
          Carregando...
        </ion-note>
      </ion-item>
    </ion-list>

    <!-- AVALIA√á√ÉO DA M√ÉE (FIXA) -->
    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Avalia√ß√£o da M√£e</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label position="stacked" class="required-label">Escore Corporal</ion-label>
        <ion-select formControlName="escoreCorporalMae" interface="action-sheet" placeholder="Selecione o escore">
          <ion-select-option value="1">1 - Muito Magro</ion-select-option>
          <ion-select-option value="2">2 - Magro</ion-select-option>
          <ion-select-option value="3">3 - Ideal</ion-select-option>
          <ion-select-option value="4">4 - Gordo</ion-select-option>
          <ion-select-option value="5">5 - Muito Gordo</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Avalia√ß√£o do √öbere</ion-label>
        <ion-select formControlName="avaliacaoUbere" interface="action-sheet" placeholder="Selecione a avalia√ß√£o">
          <ion-select-option value="1">1 - Muito Ruim</ion-select-option>
          <ion-select-option value="2">2 - Ruim</ion-select-option>
          <ion-select-option value="3">3 - Regular</ion-select-option>
          <ion-select-option value="4">4 - Bom</ion-select-option>
          <ion-select-option value="5">5 - Excelente</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Viabilidade da M√£e</ion-label>
        <ion-select formControlName="viabilidadeMae" interface="action-sheet" placeholder="Selecione a viabilidade">
          <ion-select-option value="0">0 - √ìbito</ion-select-option>
          <ion-select-option value="1">1 - Muito Fraca</ion-select-option>
          <ion-select-option value="2">2 - Fraca</ion-select-option>
          <ion-select-option value="3">3 - Regular</ion-select-option>
          <ion-select-option value="4">4 - Boa</ion-select-option>
          <ion-select-option value="5">5 - Excelente</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Habilidade Materna</ion-label>
        <ion-select formControlName="habilidadeMaterna" interface="action-sheet" placeholder="Selecione a habilidade">
          <ion-select-option value="1">1 - Muito Ruim</ion-select-option>
          <ion-select-option value="2">2 - Ruim</ion-select-option>
          <ion-select-option value="3">3 - Regular</ion-select-option>
          <ion-select-option value="4">4 - Boa</ion-select-option>
          <ion-select-option value="5">5 - Excelente</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <!-- FILIA√á√ÉO (FIXA) -->
    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Filia√ß√£o</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label position="stacked">Origem do Pai</ion-label>
        <ion-select formControlName="origemPai" (ionChange)="alternarIdentificacaoPai()"
          placeholder="Selecione a origem" interface="action-sheet">
          <ion-select-option value="proprio">Animal Pr√≥prio</ion-select-option>
          <ion-select-option value="terceiros">Animal de Terceiros</ion-select-option>
          <ion-select-option value="semen">S√™men de Terceiros</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item *ngIf="formNascidos.get('origemPai')?.value === 'proprio'">
        <ion-label position="stacked">Identifica√ß√£o do Pai</ion-label>
        <ion-select formControlName="identificacaoPai" placeholder="Selecione o pai" interface="action-sheet">
          <ion-select-option *ngFor="let animal of animaisMachos" [value]="animal.id">
            {{ formatarExibicaoGenitor(animal) }}
          </ion-select-option>
        </ion-select>
        <ion-note *ngIf="animaisMachos.length === 0 && !carregandoGenitores" color="medium" slot="end">
          Nenhum macho dispon√≠vel
        </ion-note>
        <ion-note *ngIf="carregandoGenitores" color="medium" slot="end">
          Carregando...
        </ion-note>
      </ion-item>

      <ion-item *ngIf="formNascidos.get('origemPai')?.value === 'terceiros'">
        <ion-label position="stacked">Identifica√ß√£o do Pai (Terceiros)</ion-label>
        <ion-input formControlName="identificacaoPaiTerceiros" placeholder="Identifica√ß√£o e propriet√°rio"></ion-input>
      </ion-item>

      <ion-item *ngIf="formNascidos.get('origemPai')?.value === 'semen'">
        <ion-label position="stacked">Identifica√ß√£o do Doador de S√™men</ion-label>
        <ion-input formControlName="identificacaoSemen" placeholder="Doador e propriet√°rio"></ion-input>
      </ion-item>
    </ion-list>

    <!-- CAROUSEL DE FILHOTES -->
    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">
          Filhote {{ indiceFilhoteAtual + 1 }}/{{ totalFilhotes }}
        </ion-label>
      </ion-list-header>

      <!-- SUBSTITUA toda a se√ß√£o do carousel por isto -->
      <div formArrayName="filhotes">
        <!-- üî• KEY √öNICA PARA FOR√áAR RECONSTRU√á√ÉO -->
        <div *ngFor="let filhote of filhotesArray.controls; let i = index" [formGroupName]="i" class="filhote-container"
          [class.hidden]="i !== indiceFilhoteAtual">

          <div *ngIf="i === indiceFilhoteAtual">
            <ion-item>
              <ion-label position="stacked" class="required-label">N√∫mero do Brinco</ion-label>
              <ion-input formControlName="numeroBrinco" type="text" placeholder="Ex: OV2023-001">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Nome do Animal (opcional)</ion-label>
              <ion-input formControlName="nomeAnimal" type="text" placeholder="Ex: Mimosa, Caramelo, Algod√£o">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked" class="required-label">Sexo</ion-label>
              <ion-select formControlName="sexo" placeholder="Selecione o sexo" interface="action-sheet">
                <ion-select-option value="macho">Macho</ion-select-option>
                <ion-select-option value="femea">F√™mea</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Peso ao Nascer (kg)</ion-label>
              <ion-input formControlName="peso" type="number" placeholder="Ex: 2.5"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Viabilidade ao Nascimento</ion-label>
              <ion-select formControlName="viabilidade" placeholder="Selecione a viabilidade" interface="action-sheet">
                <ion-select-option value="vivo">Saudav√©l</ion-select-option>
                <ion-select-option value="natimorto">Natimorto</ion-select-option>
                <ion-select-option value="fraco">Fraco</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label>Mamou Colostro</ion-label>
              <ion-checkbox formControlName="mamouColostro" slot="start"></ion-checkbox>
            </ion-item>
          </div>
        </div>
      </div>
      <!-- NAVEGA√á√ÉO DO CAROUSEL -->
      <div class="carousel-navigation">
        <ion-button fill="clear" (click)="filhoteAnterior()" [disabled]="indiceFilhoteAtual === 0">
          <ion-icon slot="start" name="chevron-back"></ion-icon>
          Anterior
        </ion-button>

        <span class="carousel-counter">{{ indiceFilhoteAtual + 1 }}/{{ totalFilhotes }}</span>

        <ion-button fill="clear" (click)="proximoFilhote()" [disabled]="indiceFilhoteAtual === totalFilhotes - 1">
          Pr√≥ximo
          <ion-icon slot="end" name="chevron-forward"></ion-icon>
        </ion-button>
      </div>
    </ion-list>

    <!-- OBSERVA√á√ïES GERAIS -->
    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Observa√ß√µes do Parto</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-textarea formControlName="observacoes" rows="4"
          placeholder="Outras observa√ß√µes relevantes sobre o parto..."></ion-textarea>
      </ion-item>
    </ion-list>

    <!-- BOT√ïES DE A√á√ÉO -->

<!-- Bot√µes lado a lado -->
<div class="action-buttons">
  <ion-button type="submit"
    [disabled]="!formNascidos.valid || carregandoGenitores || !validarFilhotes()">
    <ion-icon slot="start" name="save-outline"></ion-icon>
    {{ carregandoGenitores ? 'Carregando...' : 'Salvar' }}
  </ion-button>
  
  <ion-button color="medium" fill="outline" (click)="voltar()">
    Cancelar
  </ion-button>
  
</div>
  </form>

  <!-- FORMUL√ÅRIO PARA ANIMAIS COMPRADOS -->
  <form *ngIf="segmento === 'comprados'" [formGroup]="formComprados" (ngSubmit)="cadastrarComprado()"
    class="form-container">

    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Dados da Compra</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label position="stacked" class="required-label">N√∫mero do Brinco</ion-label>
        <ion-input formControlName="numeroBrinco" type="text" placeholder="Ex: OV2023-001"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Data da Compra</ion-label>
        <ion-input formControlName="dataCompra" placeholder="DD/MM/AAAA" (click)="abrirCalendario()"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Valor da Compra (R$)</ion-label>
        <ion-input formControlName="valorCompra" type="number" placeholder="0,00"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Nome do Vendedor</ion-label>
        <ion-input formControlName="vendedor" type="text" placeholder="Nome do propriet√°rio"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Ra√ßa</ion-label>
        <ion-select formControlName="raca" placeholder="Selecione a ra√ßa" interface="action-sheet">
          <ion-select-option *ngFor="let raca of racasOvinas" [value]="raca.id.toString()">
            {{raca.nome}}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked" class="required-label">Sexo</ion-label>
        <ion-select formControlName="sexo" placeholder="Selecione o sexo" interface="action-sheet">
          <ion-select-option value="macho">Macho</ion-select-option>
          <ion-select-option value="femea">F√™mea</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Caracter√≠sticas do Animal</ion-label>
      </ion-list-header>

      <!-- Status Reprodutivo apenas para F√™meas -->
      <ion-item *ngIf="formComprados.get('sexo')?.value === 'femea'">
        <ion-label position="stacked">Status Reprodutivo</ion-label>
        <ion-select formControlName="statusReprodutivo" placeholder="Selecione o status" interface="action-sheet">
          <ion-select-option value="vazia">Vazia</ion-select-option>
          <ion-select-option value="prenha">Prenha</ion-select-option>
          <ion-select-option value="lactante">Lactante</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Peso Atual (kg)</ion-label>
        <ion-input formControlName="peso" type="number" placeholder="Ex: 45.5"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Idade Aproximada</ion-label>
        <ion-input formControlName="idadeAproximada" placeholder="Ex: 2,5"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">N√∫mero de Dentes</ion-label>
        <ion-select formControlName="numeroDentes" placeholder="Selecione" interface="action-sheet">
          <ion-select-option value="0">0 (Desmamado)</ion-select-option>
          <ion-select-option value="2">2 Dentes</ion-select-option>
          <ion-select-option value="4">4 Dentes</ion-select-option>
          <ion-select-option value="6">6 Dentes</ion-select-option>
          <ion-select-option value="8">8 Dentes (Boca Cheia)</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Escore Corporal</ion-label>
        <ion-select formControlName="escoreCorporal" interface="action-sheet" placeholder="Selecione o escore">
          <ion-select-option value="1">1 - Muito Magro</ion-select-option>
          <ion-select-option value="2">2 - Magro</ion-select-option>
          <ion-select-option value="3">3 - Ideal</ion-select-option>
          <ion-select-option value="4">4 - Gordo</ion-select-option>
          <ion-select-option value="5">5 - Muito Gordo</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Documenta√ß√£o</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label>Possui Registro</ion-label>
        <ion-checkbox formControlName="possuiRegistro" slot="start"
          (ionChange)="alternarCamposRegistro()"></ion-checkbox>
      </ion-item>

      <ion-item *ngIf="formComprados.get('possuiRegistro')?.value">
        <ion-label position="stacked" class="required-label">Nome do Animal</ion-label>
        <ion-input formControlName="nomeAnimal"
          [class.invalid-field]="formComprados.get('nomeAnimal')?.invalid && formComprados.get('nomeAnimal')?.touched">
        </ion-input>
      </ion-item>

      <ion-item *ngIf="formComprados.get('possuiRegistro')?.value">
        <ion-label position="stacked" class="required-label">N√∫mero do Registro</ion-label>
        <ion-input formControlName="numeroRegistro"
          [class.invalid-field]="formComprados.get('numeroRegistro')?.invalid && formComprados.get('numeroRegistro')?.touched">
        </ion-input>
      </ion-item>

      <ion-item *ngIf="formComprados.get('possuiRegistro')?.value">
        <ion-label position="stacked">Entidade de Registro</ion-label>
        <ion-select formControlName="entidadeRegistro" placeholder="Selecione a entidade" interface="action-sheet">
          <ion-select-option value="arco">ARCO</ion-select-option>
          <ion-select-option value="abc">ABC</ion-select-option>
          <ion-select-option value="outra">Outra</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Fotos do Animal</ion-label>
      </ion-list-header>

      <div class="animal-photos">
        <div *ngFor="let foto of fotos" class="photo-container">
          <img [src]="foto" class="photo-preview" alt="Foto do animal">
          <ion-button fill="clear" color="danger" (click)="removerFoto(foto)" class="remove-photo">
            <ion-icon name="close-circle"></ion-icon>
          </ion-button>
        </div>
        <div class="add-photo-btn" (click)="adicionarFoto()">
          <ion-icon name="camera"></ion-icon>
        </div>
        <ion-note color="medium" class="helper-text">Clique para adicionar fotos do animal</ion-note>
      </div>
    </ion-list>

    <ion-list>
      <ion-list-header>
        <ion-label class="section-header">Observa√ß√µes</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-textarea formControlName="observacoes" rows="4"
          placeholder="Outras observa√ß√µes relevantes..."></ion-textarea>
      </ion-item>
    </ion-list>

    <div class="action-buttons">
      <ion-button expand="block" type="submit" [disabled]="!formComprados.valid">
        <ion-icon slot="start" name="save-outline"></ion-icon>
        Salvar
      </ion-button>

      <ion-button expand="block" color="medium" fill="outline" (click)="voltar()">
        Cancelar
      </ion-button>
      
    </div>
  </form>
</ion-content>