<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/lista-animais" [text]="''"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalhes do Animal</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Card Recolhível com Informações do Animal -->
  <div class="collapsible-card">
    <div class="card-header" (click)="toggleCard()">
      <div class="header-content">
        <div class="animal-image-container">
          <img src="assets/images/logo-ovino.png" alt="Logo OvinoGest">
        </div>
        <div class="animal-main-info">
          <h1 class="animal-id">{{ animal?.brinco || 'Carregando...' }}</h1>
          <div class="animal-status" [class]="'status-' + (animal?.situacao || 'ativo')">
            {{ animal?.situacao || 'Ativo' }}
          </div>
        </div>
      </div>
      <ion-icon [name]="isCardExpanded ? 'chevron-up-outline' : 'chevron-down-outline'" class="collapse-icon">
      </ion-icon>
    </div>

    <div class="card-content" [class.collapsed]="!isCardExpanded">
      <div class="animal-details-grid">
        <!-- Coluna 1 -->
        <div class="detail-item">
          <span class="detail-label">Raça</span>
          <span class="detail-value">{{ animal?.raca_nome || 'N/A' }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Idade</span>
          <span class="detail-value">{{ calcularIdade(animal?.data_nascimento) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Sexo</span>
          <span class="detail-value">{{ animal?.sexo || 'N/A' }}</span>
        </div>

        <!-- Coluna 2 -->
        <div class="detail-item">
          <span class="detail-label">Mãe</span>
          <span class="detail-value">
            <span *ngIf="carregandoGenitores" class="loading-text">Carregando...</span>
            <span *ngIf="!carregandoGenitores">
              {{ maeCompleta?.brinco || animal?.mae_id || 'Não informada' }}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">Categoria</span>
          <span class="detail-value">{{ animal?.categoria || 'N/A' }}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">Pai</span>
          <span class="detail-value">
            <span *ngIf="carregandoGenitores" class="loading-text">Carregando...</span>
            <span *ngIf="!carregandoGenitores">
              {{ paiCompleto?.brinco || animal?.pai_id || 'Não informado' }}
            </span>
          </span>
        </div>


        <!-- Linha 2 -->

        <div class="detail-item">
          <span class="detail-label">Peso Atual</span>
          <span class="detail-value">{{ animal?.peso_atual || 'N/A' }} kg</span>
        </div>
      </div>

      <!-- BOTÕES DE AÇÃO -->
      <div class="action-buttons">
        <div class="button-row">
          <ion-button expand="block" color="primary" class="top-button" (click)="editarAnimal()">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            EDITAR DADOS
          </ion-button>
          <ion-button expand="block" class="botao-status-custom top-button" (click)="abrirModalStatus()">
            <ion-icon name="swap-horizontal-outline" slot="start"></ion-icon>
            ALTERAR STATUS
          </ion-button>
        </div>
        <ion-button expand="block" color="secondary" class="bottom-button">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          ADICIONAR MANEJO
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Histórico de Manejos -->
  <div class="history-section">
    <h2>Histórico de Manejos</h2>

    <!-- Container das tabs com scroll horizontal -->
    <div class="segment-container">
      <ion-segment [value]="abaAtiva" (ionChange)="onSegmentChange($event)">
        <ion-segment-button value="vacinas">
          <ion-label>Vacinações</ion-label>
        </ion-segment-button>
        <ion-segment-button value="partos">
          <ion-label>Partos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="sanitarios">
          <ion-label>Sanitários</ion-label>
        </ion-segment-button>
        <ion-segment-button value="tecnicos">
          <ion-label>Técnicos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="fotos">
          <ion-label>Fotos</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Conteúdo das abas -->
    <div class="history-content">

      <!-- Vacinações -->
      <div *ngIf="abaAtiva === 'vacinas'">
        <div class="history-item" *ngFor="let manejo of manejosFiltrados">
          <div class="history-date">{{ formatarData(manejo.data) }}</div>
          <div class="history-type">Vacinação</div>
          <div class="history-details">
            <p><strong>Vacina:</strong> {{ manejo.sanitario?.vacinas[0]?.produto }}</p>
            <p><strong>Dose:</strong> {{ manejo.sanitario?.vacinas[0]?.dose }}</p>
            <p><strong>Via:</strong> {{ manejo.sanitario?.vacinas[0]?.via }}</p>
            <p><strong>Lote:</strong> {{ manejo.sanitario?.vacinas[0]?.lote }}</p>
            <p><strong>Fabricante:</strong> {{ manejo.sanitario?.vacinas[0]?.fabricante }}</p>
            <p><strong>Observação:</strong> {{ manejo.observacao }}</p>
          </div>
        </div>
      </div>

      <!-- Partos -->
      <div *ngIf="abaAtiva === 'partos'">
        <div class="history-item" *ngFor="let manejo of manejosFiltrados">
          <div class="history-date">{{ formatarData(manejo.data) }}</div>
          <div class="history-type">Parto</div>
          <div class="history-details">
            <p><strong>Tipo de Parto:</strong> {{ manejo.reprodutivo?.tipoParto }}</p>
            <p><strong>Habilidade Materna:</strong> {{ manejo.reprodutivo?.habilidadeMaterna }}</p>
            <p><strong>Quantidade de Filhotes:</strong> {{ manejo.reprodutivo?.quantidadeFilhotes }}</p>
            <p><strong>Observação:</strong> {{ manejo.observacao }}</p>
          </div>
        </div>
      </div>

      <!-- Sanitários -->
      <div *ngIf="abaAtiva === 'sanitarios'">
        <div class="history-item" *ngFor="let manejo of manejosFiltrados">
          <div class="history-date">{{ formatarData(manejo.data) }}</div>
          <div class="history-type">{{ manejo.sanitario?.medicacoes[0]?.tipo || 'Tratamento' }}</div>
          <div class="history-details">
            <p><strong>Produto:</strong> {{ manejo.sanitario?.medicacoes[0]?.produto }}</p>
            <p><strong>Dose:</strong> {{ manejo.sanitario?.medicacoes[0]?.dose }}</p>
            <p><strong>Via:</strong> {{ manejo.sanitario?.medicacoes[0]?.via }}</p>
            <p><strong>Observação:</strong> {{ manejo.observacao }}</p>
          </div>
        </div>
      </div>

      <!-- Técnicos -->
      <div *ngIf="abaAtiva === 'tecnicos'">
        <div class="history-item" *ngFor="let manejo of manejosFiltrados">
          <div class="history-date">{{ formatarData(manejo.data) }}</div>
          <div class="history-type">Controle Técnico</div>
          <div class="history-details">
            <p><strong>Peso:</strong> {{ manejo.tecnico?.peso }} kg</p>
            <p><strong>Temperatura:</strong> {{ manejo.tecnico?.temperatura }}°C</p>
            <p><strong>Escore Corporal:</strong> {{ manejo.tecnico?.escoreCorporal }}</p>
            <p><strong>Observação:</strong> {{ manejo.observacao }}</p>
          </div>
        </div>
      </div>

      <!-- Fotos -->
      <div *ngIf="abaAtiva === 'fotos'">
        <!-- Botão de adicionar nova foto -->
        <div class="action-buttons">
          <ion-button color="primary" (click)="addNewPhoto()">
            <ion-icon name="add" slot="start"></ion-icon>
            Adicionar Nova Foto
          </ion-button>
        </div>

        <!-- Grid de fotos -->
        <div class="photos-grid">
          <div *ngFor="let foto of animalFotos" class="photo-card">
            <img [src]="foto.url" [alt]="foto.descricao || 'Foto do animal'" class="photo-image">

            <div class="photo-actions">
              <ion-button size="small" color="primary" (click)="setAsProfilePhoto(foto)">
                <ion-icon name="person"></ion-icon>
              </ion-button>
              <ion-button size="small" color="secondary" (click)="viewPhoto(foto)">
                <ion-icon name="expand"></ion-icon>
              </ion-button>
            </div>

            <div class="photo-description" *ngIf="foto.descricao">
              {{ foto.descricao }}
            </div>
          </div>
        </div>

        <!-- Mensagem se não houver fotos -->
        <div class="empty-gallery" *ngIf="animalFotos.length === 0">
          <ion-icon name="images-outline"></ion-icon>
          <p>Nenhuma foto cadastrada</p>
        </div>
      </div>

      <!-- Mensagem quando não há registros -->
      <div class="empty-history" *ngIf="manejosFiltrados.length === 0 && abaAtiva !== 'fotos'">
        <ion-icon name="document-text-outline"></ion-icon>
        <p>Nenhum registro encontrado</p>
      </div>
    </div>
  </div>

  <!-- MODAL DE ALTERAR STATUS -->
  <ion-modal [isOpen]="modalStatusAberto" (ionModalDidDismiss)="fecharModalStatus()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Alterar Status do Animal</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="fecharModalStatus()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-status-content">
        <div class="animal-info-modal">
          <h3>{{ animal?.brinco || 'Carregando...' }}</h3>
          <p>{{ animal?.categoria || 'N/A' }} • {{ calcularIdade(animal?.data_nascimento) }}</p>
        </div>

        <div class="status-atual">
          <strong>Status atual:</strong>
          <span class="status-badge" [class]="'status-' + (animal?.situacao || 'ativo')">
            {{ animal?.situacao || 'Ativo' }}
          </span>
        </div>

        <div class="novo-status">
          <h4>Novo Status:</h4>

          <ion-radio-group [value]="novoStatus || 'ativo'" (ionChange)="onStatusChange($event)">
            <ion-item>
              <ion-radio value="ativo" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator ativo"></span>
                  Ativo
                </div>
              </ion-radio>
            </ion-item>

            <ion-item>
              <ion-radio value="descarte" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator descarte"></span>
                  Marcado para Descarte
                </div>
              </ion-radio>
            </ion-item>

            <ion-item>
              <ion-radio value="vendida" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator inativo"></span>
                  Vendida
                </div>
              </ion-radio>
            </ion-item>

            <ion-item>
              <ion-radio value="morta" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator inativo"></span>
                  Morta
                </div>
              </ion-radio>
            </ion-item>

            <ion-item>
              <ion-radio value="abatida" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator inativo"></span>
                  Abatida
                </div>
              </ion-radio>
            </ion-item>

            <ion-item>
              <ion-radio value="doacao" labelPlacement="end">
                <div class="status-option">
                  <span class="status-indicator inativo"></span>
                  Doação
                </div>
              </ion-radio>
            </ion-item>
          </ion-radio-group>
        </div>

        <div class="data-mudanca">
          <ion-item>
            <ion-input type="date" label="Data da mudança" [value]="dataMudanca || ''"
              (ionInput)="dataMudanca = $event.detail.value || ''">
            </ion-input>
          </ion-item>
        </div>

        <div class="observacoes">
          <ion-item>
            <ion-textarea label="Observações" rows="3" placeholder="Observações adicionais..."
              [value]="observacoesStatus || ''" (ionInput)="observacoesStatus = $event.detail.value || ''">
            </ion-textarea>
          </ion-item>
        </div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button fill="outline" (click)="fecharModalStatus()">
              Cancelar
            </ion-button>
          </ion-buttons>
          <ion-buttons slot="end">
            <ion-button (click)="confirmarMudancaStatus()" [disabled]="!novoStatus">
              Confirmar
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-content>